#!/usr/bin/env sh

PASS='\033[30m\033[1;42m PASS \033[0m'
FAIL='\033[30m\033[1;41m FAIL \033[0m'

cargo test || exit 1
cargo build --quiet
STATC=$PWD/target/debug/statc
TMP_DIR=/tmp/statc_rs
HERE=$PWD

cleanup() {
  rm -rf $TMP_DIR
}
trap cleanup EXIT
rm -rf $TMP_DIR && mkdir -p $TMP_DIR && cd $TMP_DIR

statc() { # runs the test and creates a `received.txt`
  echo "" >receieved.txt && eval $STATC $@ >>receieved.txt
  TITLE="\033[0;37m$@\033[1;0m"
}

assert() { # checks `received.txt` against $EXPECT
  echo "$EXPECT" >expected.txt
  diff -y -W 70 receieved.txt expected.txt >/dev/null
  local RC=$? # diff's return code. 0 means ok
  [[ $RC == 0 ]] && echo "$PASS $TITLE" || echo "$FAIL $TITLE"
  if [[ $RC -ne 0 ]]; then
    echo '~~~~~~~~~~~~~~~~~~~~~~~~~~'
    echo 'expected:'
    cat expected.txt
    echo '~~~~~~~~~~~~~~~~~~~~~~~~~~'
    echo 'received:'
    cat receieved.txt
    echo '~~~~~~~~~~~~~~~~~~~~~~~~~~'
    exit 1
  fi
}

statc binom 10 0.2 4
EXPECT="
X ~ B(10, 0.2)
expected  | 2
variance  | 1.6
P(X = 4)  | 0.088080384
P(X <= 4) | 0.9672065024
P(X > 4)  | 0.0327934976"
assert

statc nbinom 2 0.2 4
EXPECT="
X ~ NB(2, 0.2)
expected  | 10
variance  | 40
P(X = 4)  | 0.0768
P(X <= 4) | 0.1808
P(X > 4)  | 0.8192"
assert

statc geom 0.2 4
EXPECT="
X ~ G(0.2)
expected  | 5
variance  | 20
P(X = 4)  | 0.1024
P(X <= 4) | 0.5904
P(X > 4)  | 0.4096"
assert

statc pois 4.2 4
EXPECT="
X ~ Poisson(4.2)
expected  | 4.2
variance  | 4.2
P(X = 4)  | 0.1944236517
P(X <= 4) | 0.5898270213
P(X > 4)  | 0.4101729787"
assert

statc unif 1.9 4.2 4
EXPECT="
X ~ U(1.9, 4.2)
expected  | 3.05
variance  | 0.4408333333
pdf @ 4   | 0.4347826087
P(X <= 4) | 0.9130434783
P(X > 4)  | 0.0869565217"
assert

statc unif 1.9 4.2 4 4.1
EXPECT="
X ~ U(1.9, 4.2)
expected        | 3.05
variance        | 0.4408333333
pdf @ 4         | 0.4347826087
pdf @ 4.1       | 0.4347826087
P(X <= 4)       | 0.9130434783
P(4 < X <= 4.1) | 0.0434782609
P(X > 4.1)      | 0.0434782609"
assert

statc exp 1.9 2.5 2.6
EXPECT="
X ~ Exp(1.9)
expected          | 0.5263157895
variance          | 0.2770083102
pdf @ 2.5         | 0.0164382209
pdf @ 2.6         | 0.0135937369
P(X <= 2.5)       | 0.9913483048
P(2.5 < X <= 2.6) | 0.0014970968
P(X > 2.6)        | 0.0071545984"
assert

statc exp 1.9 2.5
EXPECT="
X ~ Exp(1.9)
expected    | 0.5263157895
variance    | 0.2770083102
pdf @ 2.5   | 0.0164382209
P(X <= 2.5) | 0.9913483048
P(X > 2.5)  | 0.0086516952"
assert

statc exp 1.9
EXPECT="
X ~ Exp(1.9)
expected | 0.5263157895
variance | 0.2770083102"
assert

statc exp 1.9 1 3 4 5
EXPECT="
X ~ Exp(1.9)
expected      | 0.5263157895
variance      | 0.2770083102
pdf @ 1       | 0.2841803765
pdf @ 3       | 0.0063573344
pdf @ 4       | 0.0009508577
pdf @ 5       | 0.0001422185
P(X <= 1)     | 0.8504313808
P(1 < X <= 3) | 0.1462226538
P(3 < X <= 4) | 0.002845514
P(4 < X <= 5) | 0.0004255996
P(X > 5)      | 0.0000748518"
assert

statc norm 1.9 1 3
EXPECT="
X ~ N(1.9, 1²)
expected  | 1.9
variance  | 1
pdf @ 3   | 0.217852177
P(X <= 3) | 0.864333939
P(X > 3)  | 0.135666061"
assert

statc inorm 1.9 1 left 0.3
EXPECT="
X ~ N(1.9, 1²)
P(X < 1.375599487291959) = 0.3"
assert

statc inorm 1.9 1 mid 0.1
EXPECT="
X ~ N(1.9, 1²)
a: left bound  | 1.7743386531
b: right bound | 2.0256613469
P(a < X <= b)  | 0.1"
assert

exit 0
