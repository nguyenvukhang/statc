#!/usr/bin/env sh

PASS='\033[30m\033[1;42m PASS \033[0m'
FAIL='\033[30m\033[1;41m FAIL \033[0m'

cargo test || exit 1
cargo build
STATS=$PWD/target/debug/stats
TMP_DIR=/tmp/stats_rs

cleanup() {
  rm -rf $TMP_DIR
}
trap cleanup EXIT
rm -rf $TMP_DIR && mkdir -p $TMP_DIR && cd $TMP_DIR

stats() {
  echo "" >receieved.txt && eval $STATS $@ >>receieved.txt
  TITLE="\033[0;37m$@\033[1;0m"
}

assert() {
  echo "$EXPECT" >expected.txt
  diff -y -W 70 receieved.txt expected.txt >/dev/null
  local RC=$?
  [[ $RC == 0 ]] && echo "$PASS $TITLE" || echo "$FAIL $TITLE"
  [[ $RC -ne 0 ]] && cat receieved.txt && exit 1
}

stats binom 10 0.2 4
EXPECT="
X ~ B(10, 0.2)
expected  | 2
variance  | 1.6
P(X = 4)  | 0.088080384
P(X <= 4) | 0.9672065024"
assert

stats nbinom 2 0.2 4
EXPECT="
X ~ NB(2, 0.2)
expected  | 8
variance  | 40
P(X = 4)  | 0.08192
P(X <= 4) | 0.34464"
assert

stats geom 0.2 4
EXPECT="
X ~ G(0.2)
expected  | 5
variance  | 20
P(X = 4)  | 0.1024
P(X <= 4) | 0.5904"
assert

stats pois 4.2 4
EXPECT="
X ~ Poisson(4.2)
expected  | 4.2
variance  | 4.2
P(X = 4)  | 0.1944236517
P(X <= 4) | 0.5898270213"
assert

stats unif 1.9 4.2 4
EXPECT="
X ~ U(1.9, 4.2)
expected  | 3.05
variance  | 0.4408333333
pdf @ 4   | 0.4347826087
P(X <= 4) | 0.9130434783"
assert

stats unif 1.9 4.2 4 4.1
EXPECT="
X ~ U(1.9, 4.2)
expected        | 3.05
variance        | 0.4408333333
pdf @ 4         | 0.4347826087
pdf @ 4.1       | 0.4347826087
P(4 < X <= 4.1) | 0.0434782609"
assert

stats exp 1.9 2.5 2.6
EXPECT="
X ~ Exp(1.9)
expected          | 0.5263157895
variance          | 0.2770083102
P(X = 2.5)        | 0.0164382209
P(X = 2.6)        | 0.0135937369
P(2.5 < X <= 2.6) | 0.0014970968"
assert

stats exp 1.9 2.5
EXPECT="
X ~ Exp(1.9)
expected    | 0.5263157895
variance    | 0.2770083102
P(X = 2.5)  | 0.0164382209
P(X <= 2.5) | 0.9913483048"
assert

stats exp 1.9
EXPECT="
X ~ Exp(1.9)
expected | 0.5263157895
variance | 0.2770083102"
assert

stats exp 1.9 1 3 4 5
EXPECT="
X ~ Exp(1.9)
expected      | 0.5263157895
variance      | 0.2770083102
P(X = 1)      | 0.2841803765
P(X = 3)      | 0.0063573344
P(X = 4)      | 0.0009508577
P(X = 5)      | 0.0001422185
P(1 < X <= 3) | 0.1462226538
P(3 < X <= 4) | 0.002845514
P(4 < X <= 5) | 0.0004255996"
assert

exit 0
